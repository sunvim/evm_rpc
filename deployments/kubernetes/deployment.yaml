apiVersion: v1
kind: ConfigMap
metadata:
  name: evm-rpc-config
  namespace: default
data:
  config.yaml: |
    chain:
      name: "bsc"
      network_id: 56
      chain_id: 56

    server:
      http:
        enabled: true
        listen_addr: "0.0.0.0:8545"
        read_timeout: 30s
        write_timeout: 30s
        idle_timeout: 120s
        max_header_bytes: 1048576
        cors_origins: ["*"]
        vhosts: ["*"]
      
      ws:
        enabled: true
        listen_addr: "0.0.0.0:8546"
        max_connections: 1000
        read_buffer_size: 1024
        write_buffer_size: 1024
      
      health:
        enabled: true
        listen_addr: "0.0.0.0:8080"

    storage:
      pika:
        addr: "pika-service:9221"
        password: ""
        db: 0
        max_connections: 500
        dial_timeout: 5s
        read_timeout: 10s
        write_timeout: 10s

    cache:
      enabled: true
      block_cache_size: 1000
      tx_cache_size: 5000
      receipt_cache_size: 5000
      balance_cache_size: 10000
      code_cache_size: 1000
      ttl:
        block: 0
        transaction: 0
        receipt: 0
        balance: 10s
        code: 3600s

    ratelimit:
      enabled: true
      global:
        requests_per_second: 1000
        burst: 2000
      ip:
        requests_per_second: 100
        burst: 200
      method:
        eth_call: 50
        eth_estimateGas: 50
        eth_getLogs: 10
        eth_sendRawTransaction: 20
        eth_getBalance: 100
        eth_blockNumber: 200

    worker_pools:
      query:
        worker_count: 100
        queue_size: 5000
      compute:
        worker_count: 16
        queue_size: 1000
      write:
        worker_count: 20
        queue_size: 1000

    evm:
      call_gas_limit: 50000000
      estimate_gas_multiplier: 1.2

    api:
      enabled_namespaces:
        - "eth"
        - "net"
        - "web3"
        - "txpool"
      
      disabled_methods:
        - "eth_mining"
        - "eth_hashrate"
        - "eth_getWork"
        - "eth_submitWork"

    metrics:
      enabled: true
      listen_addr: "0.0.0.0:9092"

    logging:
      level: "info"
      format: "json"
      output: "stdout"
      slow_query_threshold: 1s

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: evm-rpc
  namespace: default
  labels:
    app: evm-rpc
spec:
  replicas: 3
  selector:
    matchLabels:
      app: evm-rpc
  template:
    metadata:
      labels:
        app: evm-rpc
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "9092"
        prometheus.io/path: "/metrics"
    spec:
      containers:
      - name: evm-rpc
        image: evm-rpc:latest
        imagePullPolicy: IfNotPresent
        ports:
        - name: http
          containerPort: 8545
          protocol: TCP
        - name: websocket
          containerPort: 8546
          protocol: TCP
        - name: health
          containerPort: 8080
          protocol: TCP
        - name: metrics
          containerPort: 9092
          protocol: TCP
        
        env:
        - name: CHAIN_NAME
          value: "bsc"
        - name: LOG_LEVEL
          value: "info"
        
        volumeMounts:
        - name: config
          mountPath: /app/config
          readOnly: true
        
        resources:
          requests:
            cpu: 500m
            memory: 1Gi
          limits:
            cpu: 2000m
            memory: 4Gi
        
        livenessProbe:
          httpGet:
            path: /health
            port: health
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
        
        readinessProbe:
          httpGet:
            path: /health
            port: health
          initialDelaySeconds: 10
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 3
      
      volumes:
      - name: config
        configMap:
          name: evm-rpc-config

---
apiVersion: v1
kind: Service
metadata:
  name: evm-rpc-service
  namespace: default
  labels:
    app: evm-rpc
spec:
  type: LoadBalancer
  selector:
    app: evm-rpc
  ports:
  - name: http
    port: 8545
    targetPort: 8545
    protocol: TCP
  - name: websocket
    port: 8546
    targetPort: 8546
    protocol: TCP
  - name: health
    port: 8080
    targetPort: 8080
    protocol: TCP
  - name: metrics
    port: 9092
    targetPort: 9092
    protocol: TCP

---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: evm-rpc-hpa
  namespace: default
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: evm-rpc
  minReplicas: 3
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
      - type: Percent
        value: 50
        periodSeconds: 60
    scaleUp:
      stabilizationWindowSeconds: 0
      policies:
      - type: Percent
        value: 100
        periodSeconds: 30
      - type: Pods
        value: 2
        periodSeconds: 30
      selectPolicy: Max

---
apiVersion: v1
kind: Service
metadata:
  name: pika-service
  namespace: default
  labels:
    app: pika
spec:
  type: ClusterIP
  selector:
    app: pika
  ports:
  - port: 9221
    targetPort: 9221
    protocol: TCP

---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: pika
  namespace: default
spec:
  serviceName: pika-service
  replicas: 1
  selector:
    matchLabels:
      app: pika
  template:
    metadata:
      labels:
        app: pika
    spec:
      containers:
      - name: pika
        image: pikadb/pika:latest
        ports:
        - containerPort: 9221
          name: pika
        volumeMounts:
        - name: pika-data
          mountPath: /data
  volumeClaimTemplates:
  - metadata:
      name: pika-data
    spec:
      accessModes: ["ReadWriteOnce"]
      resources:
        requests:
          storage: 100Gi
